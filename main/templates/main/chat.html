{% load static %}
{% load custom_filters %}
{% load l10n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' ws://127.0.0.1:8000">
    <title>DataGPT - Chat</title>
    <script type="text/javascript" src="{% static 'jquery-3.7.1.min.js' %}"></script>
    <link rel="icon" href="{% static 'icons/favicon5.ico' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'icons/favicon5.ico' %}" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/sidebars.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/main/chat.css' %}">
    
    <link rel="stylesheet" type="text/css" href="{% static 'css/prism-tomorrow.css' %}">
    <script src="{% static 'js/prism.js' %}"></script>
    <script src="{% static 'js/prism-javascript.js' %}"></script>
    <script src="{% static 'js/prism-python.js' %}"></script>

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/sidebars.js' %}"></script>
    <script src="{% static 'crypto-js.js' %}"></script>
    <script src="{% static 'jsencrypt.js' %}"></script>
    <script>
     var publicKey = "-----BEGIN PUBLIC KEY-----\n" +
           "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAvRW2QcbKbzDobMdkLqvY\n" +
           "Fb66Ih41T1+X3spW1WP6UduM1kS+bVh7HwG23pt8e/XJAf9G4IhWTZfkgVBdMsFP\n" +
           "UfCJDiP/9cbQBgNDtT85jlFHjB1dBlJ51Hh8kDkx/1/dgy2b/ZjJ0YwAFLpk2k8W\n" +
           "ZO8wtIOEHMSdLryVh8Jkpk1qSYZPZZuW+QEE/G+TJcF286mLEpTfZ/RQN4mg/nCS\n" +
           "FhW4Rv9wnF8dhgU43kTiLwV8wVgOTKxAseDxMyvbjKiiH+u5YByZNN1hPVFSYQNx\n" +
           "06IK0Ea7wk0UTRhCwLFu2AOPGL3AylFnjlHCd+/vbDrW3WDj3KRTbZFxtysYqn3B\n" +
           "SnNZy6D1xPn79nsgWfKrgQo9KTgP9gpSoebBZwFIRmBD5Q2BpwZvbZj5lJgEYJpe\n" +
           "xH5LW6Rfv2GZjU+S5SEPNXMlSf6kmfbJAEhsyqKj+tWZtri3AfEBhG7hkmmz51zA\n" +
           "32JwSGV/IFqblOHsONsZizOl4OxzSytgfhCyOkAg6zcb5Hcd3Zod0SHscgkYPAeO\n" +
           "9ZZvD6pneRrcB1tgBPz3CSp6UOe9ktK0Lo5ZlapNUmpIR1Av/immdBnfRfB6m+ax\n" +
           "efNjY6Myl8/aepuND/E1MJviOMCm3cyrmOsNj5rwg2AIGO4vw4hdjXqOLez87t/X\n" +
           "OYNP74TrWvLmcNmlKfQNfMsCAwEAAQ==\n" +
           "-----END PUBLIC KEY-----";

    //var publicKey = "-----BEGIN PUBLIC KEY-----\n"+
    //        "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoN3aK4n9qXEsukp4AQBs\n" +
    //        "syLS54SZt43bbDRyYhPSDkg/ojLx/5nzdiTgMAdxA79b5XYC81hfA/Wjo0lj6bNw\n" +
    //        "FTDe/pfPoDNByffheshv3CEmoajOMXYjJD9uBM/FbURvaMxb1vwRLEoNusVwVn2z\n" +
    //        "N5wNtBumo5mOouM8gKQyVNSSjLIRuBjkUOXOkh/d1/fP/x8WkvyYN1x1AUBHQIMK\n" +
    //        "0n/thzYKlyPA0LCFCZwyOU04BrFJk/bTYlTvAQdGg6Wr9RcGC8lNxlAhmLKZ4hP4\n" +
    //        "lvmMfOJuf8FwcuyWzxw7qWXlnR96FTo3OE/jIDvr4u52Ak3MY2scmIdPJzXlFVnG\n" +
    //        "nwIDAQAB\n" +
    //        "-----END PUBLIC KEY-----\n";

    function generateRandomKey(length) {
      var charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      var result = "";
      for (var i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return result;
      }
      
    function sendEncryptedForm(element, mode)  {
      //event.preventDefault();
      if (mode === 'thread') {
        //Load necessary variables
        threadId = element.id;
        var form = document.getElementById("thread-form");

        //Generating AES key and appending it to the form
        var aesRawKey = generateRandomKey(16);
        var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
        localStorage.setItem("aesRawKey_rag", aesRawKey);
        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(publicKey);
        var encryptedAesKey = encrypt.encrypt(aesKey.toString(CryptoJS.enc.Base64));

        var encryptedAESKeyElement = document.createElement("input");
        encryptedAESKeyElement.type = "hidden";
        encryptedAESKeyElement.name = "encrypted_aes_key";
        encryptedAESKeyElement.id =   "encrypted_aes_key";
        encryptedAESKeyElement.value = encryptedAesKey;
        form.appendChild(encryptedAESKeyElement);

        //modify form url parameters
        var actionUrl = form.action.replace(/\/\d+\//, '/' + threadId + '/');
        form.action = actionUrl;
        form.submit();
        };
      };
      </script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
      <div class="col-lg-2 col-md-12" style="padding: 0;" id="left-sidebar">
        <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark sidebar" style="margin-left: 0;">
    <a href="{% url 'main:main_chat' %}" class="d-flex align-items-center mb-2 mb-md-0 me-md-auto text-white text-decoration-none justify-content-center" id="page_title_a">
      <img src="{% static 'icons/DataGPT_1.png' %}" alt="DataGPT" style="height: 45px; width: auto;" id="page_title">
    </a>
    <ul class="nav nav-pills flex-column" style="margin-top: 8px;">
      <li class="nav-item">
        <a href="{% url 'main:create_rag' %}" id="new-rag-btn" class="nav-link active text-center" aria-current="page" data-bs-toggle="modal" data-bs-target="#newRagModal" data-bs-whatever="@getbootstrap">
          New RAG thread
        </a>
      </li>
      {% if user|has_group:"Admin" or user|has_group:"Advanced_user" or user.is_superuser%}
      <li class="nav-item" style="margin-top: 10px; margin-bottom: 5px">
        <div style="display: flex; gap: 5px;">
          <a href="{% url 'main:main_collection' %}" id="new-collection-btn" class="nav-link active text-center" style="flex: 1; padding: 10px 5px;">
            Collections
          </a>
          {% if user|has_group:"Admin" or user.is_superuser %}
          <a href="{% url 'main:users_list' %}" id="users-btn" class="nav-link active text-center" style="flex: 1; padding: 10px 5px;">
            Users
          </a>
          {% endif %}
        </div>
      </li>
      {% endif %}
    </ul>
    <div style="max-height: 800px; overflow-y: auto; margin-top: 8px;">
    <form id="thread-form" action="{% url 'main:chat' 0 %}" method="post" style="padding: 0; margin: 0; border: 0;">
        {% csrf_token %}
    <div id="chat-sidebar">
      <ul class="list-group" id="chats">
        <input type="hidden" id="active-thread" value="{{active_thread_id}}">
        
        {% for thread in chat_threads %}
          <li class="list-group-item list-group-item-action py-3 lh-tight rag-thread {% if active_thread_id == thread.id %}current{% endif %}" 
              name="form_thread_id" 
              id="{{thread.id}}" 
              onclick="sendEncryptedForm(this, 'thread')">

            <div class="d-flex w-100 align-items-center justify-content-between">
              <strong class="mb-1 thread_name {% if active_thread_id == thread.id %}current{% endif %}">
                {{ thread.name }}
              </strong>
            </div>

            {% with thread.id as thread_id %}
              <div class="mb-1 text-small">
                {{ threads_preview|get_dict_value:thread_id }}
              </div>
            {% endwith %}
          </li>
        {% endfor %}
      </ul>
    </div>
    </form>
    </div>
    <div class="mt-auto">
    <hr>
    <div class="dropdown">
      <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle mb" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
        <img id="profile-img" alt="" width="32" height="32" class="rounded-circle me-2">
        <strong>@{{request.user.username}}</strong>
      </a>
      <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
        <li><a class="dropdown-item" href="{% url 'users:profile' %}">Profile</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'users:logout' %}">Sign out</a></li>
      </ul>
    </div>
    </div>
  </div>
  </div>
  {% if no_active_thread != True %}
  <div class="col-lg-8 col-md-12" style="margin-bottom: 0px; padding-bottom: 0px; margin-left: 0px; padding-left: 0px; border-left: 0px;">
  <div class="chat-box">
    <div class="messages" id="board">
    {% for message in messages %}
    {% if message.rag_response == False %}
        <div class="container darker">
            {% comment %} <img id="user-img" alt="Avatar" style="width: 42px; height: 42px;"> {% endcomment %}
            <p class="msg user-query" style="line-break: auto;">{{message.message|linebreaksbr}}</p>
            <span class="time-right">{{message.timestamp|time_template}}</span>
        </div>
    {% else %}
        <div class="container">
            {% localize off %}
            <input type="hidden" class="rag-response-id" id="{{message.id}}" value="{{message.id}}" >
            {% endlocalize %}
            <p class="msg rag-response" style="line-break: auto;">{{message.message|linebreaksbr}}</p>
            <p class="msg rag-response-Fa" style="line-break: auto; display: none;"></p>
            <span class="time-left">{{message.timestamp|time_template}}</span>
            <button class="copy-btn" onclick="copyThis(this.parentNode); showMessage('Copied!', this)" title="Copy response"><img id="copy-icon"></button>
            <button class="translate-btn" onclick="translateThis(this)" title="Translate"><img id="translate-icon"></button>
            <button class="context-btn" aria-current="page" data-bs-toggle="modal" data-bs-target="#contextModal" onclick="getContext(this)" title="View response context"><img id="context-icon"></button>
        </div>
    {% endif %}
    {% endfor %}
    </div>
    <div id="spinner">
    <div class="spinner-grow text-light" role="status" >
      <span class="sr-only"></span>
    </div>
    <div class="spinner-grow text-light" role="status">
      <span class="sr-only"></span>
    </div>
    <div class="spinner-grow text-light" role="status">
      <span class="sr-only"></span>
    </div>
    </div>

        <form method="post" class="form-group" id="msg-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modern-input-container">
                <!-- File attachment preview -->
                <div id="file-preview-container" style="display: none;">
                    <div class="attached-files">
                        <div class="file-item" id="file-item-template" style="display: none;">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                            </svg>
                            <span class="file-name"></span>
                            <button type="button" class="remove-file-btn" onclick="removeFile()">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Input wrapper -->
                <div class="modern-input-wrapper">
                    <!-- Text input -->
                    <textarea placeholder="Ask anything..." name="message" id="msgInput" rows="1"></textarea>
                    
                    <!-- Send button -->
                    <button type="submit" name="send" id="send_btn" title="Send message">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        </svg>
                    </button>
                </div>
            </div>
        </form>

  </div>
  </div>
  {% else %}
    <div class="col-lg-8 col-md-12 landing-page">
      <div class="landing">
        <img id="landing-img">
      </div>
    </div>
    {% endif %}
    <div class="col-lg-2 col-md-12" style="padding: 0; padding-top: 5px;" id="right-sidebar">
      {% if no_threads != True %}
      <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark sidebar-right" style="margin-right: 0px; height: 100%;">
    
        <!-- Documents Section -->
        {% if base_collection_name == None %}
          <div class="section-header with-action">
            <div style="display: flex; align-items: center;">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
                <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
              </svg>
              <h5 style="margin: 0;">Documents</h5>
            </div>
            <button class="add-icon-btn" data-bs-toggle="modal" data-bs-target="#addDocsModal" title="Add Documents">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
            </button>
          </div>
          <div class="doc-list-container">
            {% if rag_docs %}
              {% for doc in rag_docs %}
                <div class="doc-item" data-toggle="tooltip" data-placement="top" title='"{{ doc.loc|path_end_part }}" in RAG database'>
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="doc-icon">
                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                  </svg>
                  <span class="doc-name">{{ doc.name }}</span>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="opacity: 0.4; margin-bottom: 8px;">
                  <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                </svg>
                <p class="empty-text">No documents added yet</p>
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="section-header">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
              <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
            </svg>
            <h5 style="margin: 0; display: inline-block;">Collection</h5>
          </div>
          <div class="collection-item" data-bs-toggle="modal" data-bs-target="#collectionInfoModal" style="cursor: pointer;">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="collection-icon">
              <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/>
            </svg>
            <div style="flex: 1; overflow: hidden;">
              <span class="collection-name">{{ base_collection_name }}</span>
              <span class="collection-type">
                {% if base_collection_type == 'database' %}
                  {% if base_collection_db_type == 'mysql' %}
                    (MySQL database)
                  {% elif base_collection_db_type == 'sqlserver' %}
                    (SQL Server database)
                  {% elif base_collection_db_type == 'postgresql' %}
                    (PostgreSQL database)
                  {% elif base_collection_db_type == 'mongodb' %}
                    (MongoDB database)
                  {% elif base_collection_db_type == 'sqlite' %}
                    (SQLite database)
                  {% else %}
                    (Database)
                  {% endif %}
                {% elif base_collection_type == 'excel' %}
                  (Excel files)
                {% elif base_collection_type == 'document' %}
                  (Text documents)
                {% else %}
                  ({{ base_collection_type }})
                {% endif %}
              </span>
            </div>
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="opacity: 0.5; margin-left: 8px;">
              <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
          </div>
        {% endif %}
    
        <!-- Chat mode & RAG arguments (always present) -->
        <div class="settings-section">
          <!-- Mode Selection -->
          <div class="setting-card">
            <div class="setting-label">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
              </svg>
              Mode
            </div>
            {% if base_collection_type == 'database' or base_collection_type == 'excel' %}
            <div class="mode-toggle">
              <input type="radio" class="mode-input" name="chatMode" id="modeStandard" value="standard" onchange="updateMode()">
              <label class="mode-option" for="modeStandard">Standard</label>
    
              <input type="radio" class="mode-input" name="chatMode" id="modeDatabase" value="database" checked onchange="updateMode()">
              <label class="mode-option" for="modeDatabase">Database</label>
            </div>
            {% else %}
            <div class="mode-toggle">
              <input type="radio" class="mode-input" name="chatMode" id="modeStandard" value="standard" onchange="updateMode()">
              <label class="mode-option" for="modeStandard">Standard</label>
    
              <input type="radio" class="mode-input" name="chatMode" id="modeRag" value="rag" checked onchange="updateMode()">
              <label class="mode-option" for="modeRag">RAG</label>
            </div>
            {% endif %}
          </div>

          <!-- Temperature Slider -->
          <div class="setting-card" id="temperatureWrapper">
            <label for="temperature" class="setting-label-with-value">
              <span class="label-text">
                Temperature
                <span class="info-circle">i
                  <span class="tooltip-text">
                    Controls response randomness.<br>
                    <br><b>Low (0 – 0.3):</b><br>Factual, precise.<br>
                    <br><b>Medium (0.4 – 0.7):</b><br>Balanced.<br>
                    <br><b>High (0.8 – 1.0+):</b><br>Creative, less accurate. Use for brainstorming.<br>
                  </span>
                </span>
              </span>
              <span class="setting-value" id="temperatureValue">0.7</span>
            </label>
            <input type="range" class="modern-range" min="0.1" max="1.2" step="0.1" value="0.7" id="temperature" oninput="updateTemperatureLabel()">
          </div>
          <br>
          <!-- RAG Arguments -->
          {% if base_collection_type == 'database' or base_collection_type == 'excel' %}
          <div id="ragArgumentsContainer" class="rag-settings" style="display: none;">
          {% else %}
          <div id="ragArgumentsContainer" class="rag-settings">
          {% endif %}
            <div class="rag-header">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/>
              </svg>
              RAG Settings
            </div>
    
            <!-- Similarity Cutoff -->
            <div class="setting-card" id="similarityCutoffWrapper">
              <label for="similarityCutoff" class="setting-label-with-value">
                <span class="label-text">
                  Similarity Cutoff
                  <span class="info-circle">i
                    <span class="tooltip-text">
                      Filters retrieved context by relevance.<br>
                      <br><b>High cutoff:</b><br>Only top-matches → precise, may miss info.<br>
                      <br><b>Low cutoff:</b><br>More matches → broader, may add noise.<br>
                      <br>Raise if answers feel noisy; lower if context feels missing.
                    </span>
                  </span>
                </span>
                <span class="setting-value" id="cutoffValue">0.50</span>
              </label>
              <input type="range" class="modern-range" min="0.25" max="0.95" step="0.05" value="0.50" id="similarityCutoff" oninput="updateCutoffLabel()">
            </div>
    
            <!-- Rerank Toggle -->
            <div class="setting-card toggle-card">
              <label class="toggle-label" for="rerankSwitch" id="rerankLabel">
                <span class="label-text">
                  Reranker
                  <span class="info-circle">i
                    <span class="tooltip-text">
                      Reorders retrieved chunks by relevance.<br>
                      <br><b>ON:</b><br>Probably better quality but slower.<br>
                      <br><b>OFF:</b><br>Faster, but less reliable.
                    </span>
                  </span>
                </span>
                <label class="toggle-switch">
                  <input type="checkbox" id="rerankSwitch">
                  <span class="toggle-slider"></span>
                </label>
              </label>
            </div>
          </div>
        </div>
    
        <!-- Always at bottom: Delete button -->
        <div class="mt-auto" style="margin-bottom: 1rem;">
          <a href="{% url 'main:delete_thread' active_thread_id %}" id="delete-thread-btn" class="delete-thread-btn" title="Delete this thread">
            <div class="delete-icon-wrapper">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
              </svg>
            </div>
            <span class="delete-text">Delete Thread</span>
          </a>
        </div>
    
      </div>
      {% endif %}
    </div>
 


</div>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmTitle" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content dark-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmTitle">Delete thread?</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0" style="color: #cfcfcf; font-size: 13px;">This action cannot be undone. Are you sure you want to delete this thread?</p>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="newRagModal" tabindex="0" aria-labelledby="newRag" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content dark-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="newRag">Create a new RAG thread</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" data-bs-newRagName="{{ new_rag_name }}"></button>
      </div>
      <div class="modal-body">
        <form action="{%  url 'main:create_rag' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
          <div class="mb-3">
            <label for="rag-name" class="col-form-label">RAG name</label>
            <input type="text" class="form-control" id="rag-name" name="new-rag-name">
          </div>
          <div class="mb-3">
          <label for="llm" class="col-form-label">Base documents collection</label>
          <select class="form-select" name="base-collection-id">
            <option value='None'>None</option>
            <optgroup label="Document collections">
            <option value='all_docs_collection'>*All Documents*</option>
              {% for collection in collections %}
                <option value='{{ collection.id }}'>{{ collection.name }}</option>
              {% endfor %}
            </optgroup>
          </select>
          </div>
          <div class="mb-3">
          <label for="llm" class="col-form-label">LLM</label>
          <input type="text" class="form-control" id="llm" value="{{ model_name }}" disabled>
          </div>
          <div class="mb-3" id="doc-form-div">
            <label for="docForm" class="form-label">Add knowledge source</label>
            <input class="form-control" type="file" id="docForm" name="files" multiple>
          </div>
          <div id="uploadedDocuments" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <div class="spinner-border text-primary" id="spinner_loader" role="status" style="display: none;">
          <span class="sr-only"></span>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Discard</button>
        <button type="submit" class="btn btn-primary" onclick="spinnerAppears(); checkNewName(event)">Create</button>
      </div>
      </form>
    </div>
  </div>
</div>
{% if no_threads != True %}
<div class="modal fade" id="addDocsModal" tabindex="0" aria-labelledby="addDocs" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content dark-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="addDocs">Add new documents</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" data-bs-newRagName="{{ new_rag_name }}"></button>
      </div>
      <div class="modal-body">
        <form action="{%  url 'main:add_docs' active_thread_id %}" method="post" enctype="multipart/form-data" id="chat-add-docs-form">
        {% csrf_token %}
          <div class="mb-3">
            <label for="rag-name" class="col-form-label">RAG name</label>
            <input type="text" class="form-control" id="rag-name" name="new-rag-name" value="{{ active_thread_name }}" disabled>
          </div>
          <div class="mb-3">
            <label for="docForm" class="form-label">Add knowledge source</label>
            <input class="form-control" type="file" id="docForm" name="files" multiple>
          </div>
          <div id="uploadedDocuments" class="mt-3"></div>
      </div>
      <div class="modal-footer modal-footer-custom">
        <div class="progress-indicator" id="progress_indicator_chat" style="display: none; flex: 1; margin-right: auto;">
          <span id="progress_text_chat" style="color: #aaa;"></span>
          <span id="progress_filename_chat" style="color: #00ff88; font-weight: bold; margin-left: 8px;"></span>
          <span id="progress_status_chat" style="color: #aaa; margin-left: 4px;"></span>
        </div>
        <div class="spinner-border text-primary" id="spinner_loader_2" role="status" style="display: none;">
          <span class="sr-only"></span>
        </div>
        <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-modal-add-docs" onclick="submitChatAddDocsForm(event)">Add Documents</button>
      </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="contextModal" tabindex="0" aria-labelledby="context" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content" style="background: linear-gradient(135deg, #083042 0%, #0e323e 50%, #1e3843 100%); border: 1px solid rgba(13, 110, 253, 0.4);">
      <div class="modal-header" style="border-bottom: 1px solid rgba(53, 96, 164, 0.798);">
        <h5 class="modal-title" id="context" style="color: #ffffff; font-weight: 600;">Response contexts</h5>
      </div>
      <div class="modal-body">
          <div class="mb-3" id="context-div">
          </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% if base_collection_name != None %}
<!-- Collection Info Modal -->
<div class="modal fade" id="collectionInfoModal" tabindex="-1" aria-labelledby="collectionInfoTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content dark-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="collectionInfoTitle">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
            <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/>
          </svg>
          {{ base_collection_name }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="collection-info">
          <div class="info-row">
            <span class="info-label">Type:</span>
            <span class="info-value">
              {% if base_collection_type == 'database' %}
                {% if base_collection_db_type == 'mysql' %}
                  MySQL Database
                {% elif base_collection_db_type == 'sqlserver' %}
                  SQL Server Database
                {% elif base_collection_db_type == 'postgresql' %}
                  PostgreSQL Database
                {% elif base_collection_db_type == 'mongodb' %}
                  MongoDB Database
                {% elif base_collection_db_type == 'sqlite' %}
                  SQLite Database
                {% else %}
                  Database
                {% endif %}
              {% elif base_collection_type == 'excel' %}
                Excel Files
              {% elif base_collection_type == 'document' %}
                Text Documents
              {% else %}
                {{ base_collection_type|title }}
              {% endif %}
            </span>
          </div>
          {% if base_collection.db_schema_analysis %}
          <div class="info-section">
            <div class="analysis-content">
              {{ base_collection.db_schema_analysis|markdown_to_html }}
            </div>
          </div>
          {% endif %}
          
          <!-- Display collection documents for document-type collections -->
          {% if base_collection_type == 'document' %}
            {% if collection_docs %}
            <div class="info-section">
              <h6 class="section-title">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px; vertical-align: text-top;">
                  <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                  <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                </svg>
                Collection Documents <span style="color: #888; font-weight: 400; font-size: 12px;">({{ collection_docs|length }} file{{ collection_docs|length|pluralize }})</span>
              </h6>
              <div class="document-list">
                {% for doc in collection_docs %}
                  <div class="document-item">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                    </svg>
                    <div class="doc-details">
                      <div class="doc-title">{{ doc.name }}</div>
                      <div class="doc-path">{{ doc.loc|path_end_part }}</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% else %}
            <div class="info-section">
              <div class="empty-state">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16" style="color: #555; margin-bottom: 8px;">
                  <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                </svg>
                <p class="empty-text">No documents in this collection</p>
              </div>
            </div>
            {% endif %}
          {% endif %}
          
          {% if rag_docs and base_collection_type != 'document' %}
          <div class="info-section">
            <h6 class="section-title">Included Documents:</h6>
            <div class="document-list">
              {% for doc in rag_docs %}
                <div class="document-item">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                  </svg>
                  <div class="doc-details">
                    <div class="doc-title">{{ doc.name }}</div>
                    <div class="doc-path">{{ doc.loc|path_end_part }}</div>
                  </div>
                </div>
              {% endfor %}\n            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
var status = "free";
var scroll_status = 1;
var copyButtons = document.getElementsByClassName('copy-btn');
var spinner = document.getElementById("spinner");
var spinnerLoader = document.getElementById("spinner_loader");
var spinnerLoader2 = document.getElementById("spinner_loader_2");
var deleteThreadBtn = document.getElementById("delete-thread-btn");
let lastScrollTop = 0; // for detecting upward scrolls

// Delete confirmation modal
const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
let deleteThreadTarget = null;

if (deleteThreadBtn && deleteConfirmModalEl && confirmDeleteBtn) {
  const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl);
  deleteThreadBtn.addEventListener('click', function(e) {
    e.preventDefault();
    deleteThreadTarget = deleteThreadBtn.getAttribute('href');
    deleteConfirmModal.show();
  });

  confirmDeleteBtn.addEventListener('click', function() {
    if (deleteThreadTarget) {
      window.location.href = deleteThreadTarget;
    }
  });
}


function copyTextToClipboard(text) {
  var textarea = document.createElement("textarea");
  textarea.value = text;
  // Make the textarea non-editable to avoid focus and move outside of view
  textarea.setAttribute("readonly", "");
  textarea.style.position = "absolute";
  textarea.style.left = "-9999px";
  // Add the textarea to the HTML document
  document.body.appendChild(textarea);
  // Select and copy the text inside the textarea
  textarea.select();
  document.execCommand("copy");
  // Remove the textarea from the document
  document.body.removeChild(textarea);
}

function copyThis(container) {
  var ragResponse = container.querySelector('.rag-response');
  var ragResponsePersian = container.querySelector('.rag-response-Fa');
  var messageText = ragResponse.textContent;
  var messageTextPersian = ragResponsePersian.textContent;
  
  if (ragResponsePersian.style.display === 'block') {
    // Copy Persian text to clipboard
    //window.navigator.clipboard.writeText(messageTextPersian);
    copyTextToClipboard(messageTextPersian);
  } else {
    // Copy regular text to clipboard
    //window.navigator.clipboard.writeText(messageText);
    copyTextToClipboard(messageText);
  }
}


// Add event listener to each copy button
//Array.from(copyButtons).forEach(function(button) {
//    button.addEventListener('click', function() {
//        var ragResponse = this.parentNode.querySelector('.rag-response');
//        var ragResponsePersian = this.parentNode.querySelector('.rag-response-Fa');
//        var messageText = this.parentNode.querySelector('.rag-response').textContent;
//        var messageTextPersian = this.parentNode.querySelector('.rag-response-Fa').textContent;
//        if (ragResponse.style.display === 'none') {
//          copyToClipboard(messageTextPersian);
//        } else {
//          copyToClipboard(messageText);
//        }
//    });
//});


function showMessage(message, button) {
  const messageBox = document.createElement('div');
  messageBox.textContent = message;
  messageBox.classList.add('showing-message');
  button.appendChild(messageBox);

  const buttonRect = button.getBoundingClientRect();
  const messageBoxRect = messageBox.getBoundingClientRect();
  const topOffset = buttonRect.top - messageBoxRect.height + 10;
  const leftOffset = buttonRect.left + (buttonRect.width - messageBoxRect.width) / 2;

  messageBox.style.top = topOffset + 'px';
  messageBox.style.left = leftOffset + 'px';

  setTimeout(function() {
    messageBox.remove();
  }, 500);
}


// Websocket stuff
var loc = window.location

var protocol = 'ws://';
if (loc.protocol == "https:") {protocol = 'wss://'};
var endpoint = protocol + loc.host + loc.pathname;
var socket = new WebSocket(endpoint);
console.log("endpoint-onload: " + endpoint);

var formData = $("#msg-form")
var msgInput = $("#msgInput")
var board = $("#board")

const user_prompt = '<div class="container darker">' + 
//'<img id="user-img" alt="Avatar" style="width: 42px; height: 42px;">' +
'<p class="msg user-query" style="line-break: auto;">{prompt}</p>' + 
'<span class="time-right">{time}</span>' +
'</div>'

const rag_response = '<div class="container">' +
'<input type="hidden" class="rag-response-id" id="{{message.id}}" value="{{message.id}}" >' +
'<p class="msg rag-response" style="line-break: auto;">{rag_response}</p>' +
'<p class="msg rag-response-Fa" style="line-break: auto; display: none;"></p>' +
'<span class="time-right">{time}</span>' +
'<button class="copy-btn" onclick="copyThis(this.parentNode); showMessage(\'Copied!\', this)"><img id="copy-icon"></button>' +
'<button class="translate-btn" onclick="translateThis(this)"><img id="translate-icon"></button>' +
'<button class="context-btn" aria-current="page" data-bs-toggle="modal" data-bs-target="#contextModal" onclick="getContext(this)"><img id="context-icon"></button>' +
'</div>'

const contextField = '<label for="{context_id}" class="col-form-label" style="color: #ffffff; font-weight: bold; font-size: 14px;">{context_label}</label>' + 
'<textarea type="text" class="form-control" rows="{rows}" id="{context_id}" style="font-family: monospace; font-size: 12px; white-space: pre-wrap; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(13, 110, 253, 0.4); color: #e0e0e0;" disabled>{context_text}</textarea>'

function decrypt_text(text) {
    var aesRawKey = localStorage.getItem("aesRawKey_rag");
    var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
    var decryptedText = CryptoJS.AES.decrypt(text, aesKey, {mode: CryptoJS.mode.ECB});
    var decryptedTextValue = decryptedText.toString(CryptoJS.enc.Utf8);
    decryptedTextValue = decryptedTextValue.replace(/[\x00-\x09\x0B-\x1F\x7F-\x9F]/g, '');
    return decryptedTextValue;
}

function translateThis(element) {
  if (status === "free") {
  var translateIcon = element.querySelector('#translate-icon');
  translateIcon.classList.add('spin-animation');
  var container = element.parentNode;
  var messageElement = container.querySelector('.msg.rag-response');
  var persianTranslationElement = container.querySelector('.msg.rag-response-Fa');
  if (persianTranslationElement.textContent === "") {
    var messageId = container.querySelector('.rag-response-id').value;
    //var messageText = messageElement.textContent;
    //messageText = messageText.replace('<br>',"\n");
    var aesRawKey = generateRandomKey(16);
    var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
    localStorage.setItem("aesRawKey_rag", aesRawKey);
    //var encryptedMessageText = CryptoJS.AES.encrypt(messageText, aesKey, {mode: CryptoJS.mode.ECB}).toString();
    var encrypt = new JSEncrypt();
    encrypt.setPublicKey(publicKey);
    var encryptedAesKey = encrypt.encrypt(aesKey.toString(CryptoJS.enc.Base64));
    var data = {
      "mode": "translation",
      'message_id': messageId,
      //'encrypted_message': encryptedMessageText,
      'encrypted_aes_key' : encryptedAesKey
      }
    socket.send(JSON.stringify(data));
  } else { 
    if (persianTranslationElement.style.display === 'block') {
      persianTranslationElement.style.display = 'none';
      messageElement.style.display = 'block';
      translateIcon.classList.remove('spin-animation');
  } else {
    persianTranslationElement.style.display = 'block';
    messageElement.style.display = 'none';
    translateIcon.classList.remove('spin-animation');
  }}
}
};


socket.onopen = function(e) {
  console.log("open", e);

  formData.submit(function(event) {
    event.preventDefault();

    if (status === "free") {
      status = "working";
      var msgVal = msgInput.val();

      // Determine current chat mode from toggle
      const chatMode = document.querySelector('input[name="chatMode"]:checked').value;
      const similarityCutoff = parseFloat(document.getElementById("similarityCutoff").value);
      const temperature = parseFloat(document.getElementById("temperature").value);
      const rerankEnabled = document.getElementById("rerankSwitch").checked; // new line


      // Encrypt user message
      var aesRawKey = generateRandomKey(16);
      var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
      localStorage.setItem("aesRawKey_rag", aesRawKey);
      var encryptedMsgVal = CryptoJS.AES.encrypt(msgVal, aesKey, { mode: CryptoJS.mode.ECB }).toString();

      // Encrypt AES key with RSA
      var encrypt = new JSEncrypt();
      encrypt.setPublicKey(publicKey);
      var encryptedAesKey = encrypt.encrypt(aesKey.toString(CryptoJS.enc.Base64));

      // Send payload including chat mode
      var data = {
        encrypted_message: encryptedMsgVal,
        encrypted_aes_key: encryptedAesKey,
        chat_mode: chatMode,
        similarity_cutoff: similarityCutoff,
        rerank: rerankEnabled,
        temperature: temperature,
      };
      socket.send(JSON.stringify(data));

      // UI update
      var today = new Date();
      var time = today.getHours() + ":" + today.getMinutes().toString().padStart(2, '0');
      var field = user_prompt.replace('{prompt}', msgInput.val());
      field = field.replace('{time}', "Today  " + time);
      $('#board').append(field);

      var userQueries = document.getElementsByClassName("user-query");
      lastUserQuery = userQueries[userQueries.length - 1];
      if (inferTextareaLanguage(lastUserQuery.textContent) === 'Persian') {
        lastUserQuery.classList.remove('user-query');
        lastUserQuery.classList.add('user-query-Fa');
        lastUserQuery.style.fontFamily = "IranSans";
        lastUserQuery.style.fontSize = '15px';
        lastUserQuery.style.fontWeight = 'bold';
        lastUserQuery.style.textAlign = 'right';
        lastUserQuery.style.color = 'white';
        lastUserQuery.dir = 'rtl';
        lastUserQuery.style.paddingRight = '10px';
        lastUserQuery.style.lineHeight = 1.65;
      }

      scrollToEnd();
      msgInput.val('');
      formData[0].reset();
      
      // Reset textarea direction and font to LTR/English
      const msgTextarea = document.getElementById('msgInput');
      if (msgTextarea) {
        msgTextarea.style.direction = 'ltr';
        msgTextarea.style.textAlign = 'left';
        msgTextarea.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        msgTextarea.style.height = 'auto';
      }
      
      spinner.style.display = 'block';
    }
  });
};


socket.onmessage = function(e) {
    var chatMsgData = JSON.parse(e.data)
    var today = new Date();
    var time = today.getHours() + ":" + today.getMinutes().toString().padStart(2, '0');
    if (chatMsgData.mode === "translation") {
      var encryptedPersianTranslation = chatMsgData.encrypted_persian_translation;
      var persianTranslation = decrypt_text(encryptedPersianTranslation)
      var messageId = chatMsgData.message_id;
      // Remove commas from messageId if present (SQL Server formatting)
      if (typeof messageId === 'string') {
        messageId = messageId.replace(/,/g, '');
      }
      console.log('Translation received for message ID:', messageId);
      var messageElement = document.getElementById(messageId);
      if (!messageElement) {
        console.error('Could not find message element with ID:', messageId);
        return;
      }
      var container = messageElement.parentNode;
      var persianTextBox = container.querySelector('.msg.rag-response-Fa');
      var englishTextBox = container.querySelector('.msg.rag-response');
      
      // Apply markdown rendering to Persian translation (for LLM translations with markdown)
      var renderedPersianTranslation = renderLightMarkdown(persianTranslation);
      persianTextBox.innerHTML = renderedPersianTranslation;
      
      persianTextBox.style.display = "block";
      englishTextBox.style.display = "none";
      persianTextBox.style.fontFamily = "IranSans";
      persianTextBox.style.fontSize = '13px';
      persianTextBox.style.fontWeight = 'bold';
      persianTextBox.style.textAlign = 'right';
      persianTextBox.style.color = 'white';
      persianTextBox.dir = 'rtl';
      persianTextBox.style.lineHeight = 1.65;
      persianTextBox.style.paddingRight = '10px';
      var translateIcon = container.querySelector('#translate-icon');
      translateIcon.classList.remove('spin-animation');
    } else if (chatMsgData.mode === "context") {
        var encryptedContexts = chatMsgData.encrypted_contexts;
        var contextDiv = document.getElementById("context-div");
        
        // Check if context is empty
        if (!encryptedContexts || Object.keys(encryptedContexts).length === 0) {
          contextDiv.innerHTML = '<div class="alert alert-info" style="background: rgba(13, 110, 253, 0.18); border: 1px solid rgba(13, 110, 253, 0.5); color: #4a8fd9; border-radius: 8px; padding: 16px; margin: 10px 0;">' +
                                 '<strong>No Context Available</strong><br>' +
                                 'This response was generated without any specific knowledge source or retrieved documents.' +
                                 '</div>';
        } else {
          Object.keys(encryptedContexts).forEach(function(encryptedKey, index) {
            var contextId = "context-" + (index + 1);
            var key = decrypt_text(encryptedKey)
            // var contextLabel = "#" + (index + 1) + ": " + key;
            var contextLabel = key + ": ";
            var encryptedContextText = encryptedContexts[encryptedKey];
            var contextText = decrypt_text(encryptedContextText)
            
            // Determine number of rows based on content length and type
            var rows = 5;  // default
            if (key.toLowerCase().includes('query')) {
              // For queries, use fewer rows initially
              rows = Math.min(10, Math.max(3, Math.ceil(contextText.split('\n').length)));
            } else if (key.toLowerCase().includes('result') || key.toLowerCase().includes('error')) {
              // For results and errors, use more rows
              rows = Math.min(20, Math.max(8, Math.ceil(contextText.split('\n').length)));
            }
            
            var context = contextField.replace("{context_id}", contextId);
            context = context.replace("{context_label}", contextLabel);
            context = context.replace("{context_text}", contextText);
            context = context.replace("{rows}", rows);
            
            contextDiv.innerHTML += context;
          });
        }
    } else if (chatMsgData.mode === "new") {
      status = "working";
  scroll_status = 1;
      var field = rag_response.replace('{rag_response}', chatMsgData.message);
      field = field.replace('{time}', "Today  " + time);
      $('#board').append(field);
  scrollToEnd(scroll_status);
      copyButtons = document.getElementsByClassName('copy-btn');
      // Add event listener to each copy button
      Array.from(copyButtons).forEach(function(button) {
        button.addEventListener('click', function() {
          var messageText = this.parentNode.querySelector('.rag-response').textContent;
          copyToClipboard(messageText);
        });
      });
    } else if (chatMsgData.mode === "last") {
      scroll_status = 1;
      var messageId = chatMsgData.message_id;
      const ragResponses = document.getElementsByClassName('rag-response');
      const lastRagResponse = ragResponses[ragResponses.length - 1];
      var container = lastRagResponse.parentNode;
      var id_input = container.querySelector('.rag-response-id');
      id_input.id = messageId;
      id_input.value = messageId;
      status = "free";
    } else {
      spinner.style.display = 'none';

      // ✅ ignore if no actual message payload
      if (!chatMsgData.message || chatMsgData.message.trim() === "") {
        return;
      }

      let msgText;
      try {
        // ✅ Decrypt the newly streamed chunk
        msgText = decrypt_text(chatMsgData.message);
      } catch (err) {
        console.error("Decryption failed:", err, chatMsgData.message);
        return; // skip this chunk if bad ciphertext
      }

      const ragResponses = document.getElementsByClassName('rag-response');
      if (ragResponses.length === 0) return; // safety

      const lastRagResponse = ragResponses[ragResponses.length - 1];

      // ✅ Keep a raw plaintext buffer on the element (survives re-renders)
      const prevRaw = lastRagResponse.dataset.raw || "";
      const nextRaw = prevRaw + msgText;
      lastRagResponse.dataset.raw = nextRaw;

      // ✅ Re-render the entire message from raw each time
      // This handles headings, bold, hr, tables, and now code blocks
      const rendered = renderLightMarkdown(nextRaw);
      lastRagResponse.innerHTML = rendered;
      // Prism.js: highlight all code blocks after update
      if (window.Prism) {
        Prism.highlightAll();
      }

        // Prism.js: highlight all code blocks after update
        if (window.Prism) {
          Prism.highlightAll();
        }

  // Add copy buttons to any new code blocks after streaming update
  if (typeof installCodeCopy === 'function') installCodeCopy(lastRagResponse);

      // ✅ Language direction detection excluding code blocks (<pre> elements)
      const tmpNode = lastRagResponse.cloneNode(true);
      tmpNode.querySelectorAll('pre').forEach(n => n.remove());
      const visibleText = (tmpNode.textContent || "").trim();
      const englishChars = (visibleText.match(/[A-Za-z]/g) || []).length;
      const totalChars = visibleText.length || 1;

      if (englishChars / totalChars > 0.3) {
        // Mostly English → LTR
        lastRagResponse.style.direction = "ltr";
        lastRagResponse.style.textAlign = "left";
        lastRagResponse.style.fontSize = "17px";
        lastRagResponse.style.fontFamily = "Calibri";
        lastRagResponse.style.fontWeight = "normal";
        lastRagResponse.style.lineHeight = 1.7;
        lastRagResponse.style.paddingRight = "10px";
      } else {
        // Otherwise consider Persian → RTL
        lastRagResponse.style.direction = "rtl";
        lastRagResponse.style.textAlign = "right";
        lastRagResponse.style.fontSize = "15px";
        lastRagResponse.style.fontFamily = "IranSans";
        lastRagResponse.style.fontWeight = "bold";
        lastRagResponse.style.lineHeight = 1.7;
        lastRagResponse.style.paddingRight = "10px";
      }

      scrollToEndIfNearBottom();
      // scrollToEnd();
    }
}


socket.onerror  = function(e) {
    console.log ("error", e)
}
socket.onclose  = function(e) {
    console.log ("close", e)
    var loc = window.location

    var protocol = 'ws://';
    if (loc.protocol == "https:") {protocol = 'wss://'};
    var endpoint = protocol + loc.host + loc.pathname;
    var socket = new WebSocket(endpoint);
    console.log("endpoint-onload: " + endpoint);
}

window.onunload = function () {
    socket.close();
}


/*   Scroller function */

function scrollToEnd(statusArg) {
  const s = (typeof statusArg === 'number') ? statusArg : scroll_status;
  if (s !== 1) return;
  programmaticScroll = true;
  const targetTop = $('#board')[0].scrollHeight;
  $('#board').stop().animate({
    scrollTop: targetTop
  }, 300, function() { programmaticScroll = false; });
}

let userScrolling = false;
const scrollThreshold = 200; // distance from bottom to still auto-scroll

const $board = $('#board');
let programmaticScroll = false;   // ignore scroll events from our own animations
let userScrollIntent = false;     // recent user interaction suggests manual scrolling
let intentTimeoutId = null;

// Detect user scroll
$board.on('scroll', function() {
  const currentTop = $board.scrollTop();
  if (!programmaticScroll) {
    const upDelta = lastScrollTop - currentTop; // positive if moved up
    // Lock only when user intended to scroll and actually moved up a bit
    if (userScrollIntent && upDelta > 2) {
      scroll_status = 0;
    }
  }
  lastScrollTop = currentTop;

  userScrolling = true;
  // Reset after a short delay to allow auto-scroll again (only when near bottom)
  clearTimeout($board.data('scrollTimeout'));
  $board.data('scrollTimeout', setTimeout(() => {
    userScrolling = false;
  }, 500));
});

// Mark user intent on interactions that typically precede a manual scroll
$board.on('wheel touchstart pointerdown mousedown', function() {
  userScrollIntent = true;
  if (intentTimeoutId) clearTimeout(intentTimeoutId);
  intentTimeoutId = setTimeout(() => { userScrollIntent = false; }, 800);
});

document.addEventListener('keydown', (e) => {
  const upKeys = ['ArrowUp', 'PageUp', 'Home'];
  if (upKeys.includes(e.key)) {
    userScrollIntent = true;
    if (intentTimeoutId) clearTimeout(intentTimeoutId);
    intentTimeoutId = setTimeout(() => { userScrollIntent = false; }, 800);
  }
});

function scrollToEndIfNearBottom() {
  if (scroll_status !== 1) return; // respect user scroll-up lock
  const scrollTop = $board.scrollTop();
  const scrollHeight = $board[0].scrollHeight;
  const clientHeight = $board.innerHeight();

  const maxScrollTop = Math.max(0, scrollHeight - clientHeight);

  // Only auto-scroll if user is not actively scrolling and near bottom
  if (!userScrolling && scrollTop >= maxScrollTop - scrollThreshold) {
    $board.stop().animate({
      scrollTop: scrollHeight
    }, 700);
  }
}

/* END of scroller function */


function isPersianText(input) {
  let visibleText = '';
  // If an element is passed, clone and strip <pre> blocks
  if (input && typeof input === 'object' && input.nodeType === 1) {
    const tmp = input.cloneNode(true);
    tmp.querySelectorAll('pre').forEach(n => n.remove());
    visibleText = (tmp.textContent || '').trim();
  } else {
    const str = String(input || '');
    if (/<pre[\s>]/i.test(str)) {
      const tmp = document.createElement('div');
      tmp.innerHTML = str;
      tmp.querySelectorAll('pre').forEach(n => n.remove());
      visibleText = (tmp.textContent || '').trim();
    } else {
      visibleText = str;
    }
  }

  const totalChars = visibleText.length || 1;
  const englishChars = (visibleText.match(/[A-Za-z]/g) || []).length;
  // Return true for Persian styling when English proportion is not dominant (>30%)
  return (englishChars / totalChars) <= 0.3;
}

// 🔹 simple bold formatter
function formatBold(text) {
  // Replace **something** with <b>something</b>
  return text.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
}

// Escape HTML to avoid accidental tag injection
function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// Decode any pre-escaped HTML entities so we don't double-escape them later
function decodeHtmlEntities(str) {
  const txt = document.createElement('textarea');
  txt.innerHTML = str;
  return txt.value;
}

// Inline markdown (bold) for a line
function applyInlineFormatting(text) {
  // **bold**
  return text.replace(/\*\*([^*\n]+?)\*\*/g, "<b>$1</b>");
}

// Lightweight Markdown renderer for streaming:
// - Headings: # .. ######
// - Horizontal rule: --- / *** / ___ (optional)
// - Bold: **text**
function renderLightMarkdown(raw) {
  const decoded = decodeHtmlEntities(raw);
  const safe = escapeHtml(decoded).replace(/\r\n?/g, "\n");
  const lines = safe.split("\n");
  const out = [];

  for (let line of lines) {
    // hr
    if (/^\s{0,3}(?:-{3,}|\*{3,}|_{3,})\s*$/.test(line)) {
      out.push("<hr>");
      continue;
    }
    // headings
    const h = line.match(/^\s{0,3}(#{1,6})\s+(.*)$/);
    if (h) {
      const level = h[1].length;
      const content = applyInlineFormatting(h[2].trim());
      out.push(`<h${level}>${content}</h${level}>`);
      continue;
    }
    // normal line with inline formatting
    out.push(applyInlineFormatting(line));
  }

  // Join with <br> so line breaks are preserved
  return out.join("<br>");
}


function renderLightMarkdown(raw) {
  const decoded = decodeHtmlEntities(raw);
  const safe = escapeHtml(decoded).replace(/\r\n?/g, "\n");
  const lines = safe.split("\n");
  const out = [];

  let i = 0;
  let inCodeBlock = false;
  let codeLang = "";

  while (i < lines.length) {
    let line = lines[i];

    // 🔹 detect start/end of code block
    const codeBlockStart = line.match(/^```(\w*)/);
    if (codeBlockStart) {
      if (!inCodeBlock) {
        inCodeBlock = true;
        codeLang = codeBlockStart[1] || "";
        out.push(`<pre><code class="language-python">`);
      } else {
        inCodeBlock = false;
        codeLang = "";
        out.push("</code></pre>");
      }
      i++;
      continue;
    }

    if (inCodeBlock) {
      // inside code block, content is already escaped once in `safe`; avoid double-escaping
      out.push(line + "\n");
      i++;
      continue;
    }

    // hr
    if (/^\s{0,3}(?:-{3,}|\*{3,}|_{3,})\s*$/.test(line)) {
      out.push("<hr>");
      i++;
      continue;
    }

    // headings
    const h = line.match(/^\s{0,3}(#{1,6})\s+(.*)$/);
    if (h) {
      const level = h[1].length;
      const content = applyInlineFormatting(h[2].trim());
      out.push(`<h${level}>${content}</h${level}>`);
      i++;
      continue;
    }

    // table detection (header + separator + rows)
    if (
      line.trim().startsWith("|") &&
      i + 1 < lines.length &&
      /^\s*\|?(\s*[:-]-+[:-]?\s*\|)+\s*$/.test(lines[i + 1])
    ) {
      const headers = line
        .trim()
        .split("|")
        .slice(1, -1)
        .map((h) => applyInlineFormatting(h.trim()));
      const aligns = lines[i + 1]
        .trim()
        .split("|")
        .slice(1, -1)
        .map((a) => {
          if (/^:\s*-+\s*:$/.test(a)) return "center";
          if (/^:\s*-+/.test(a)) return "left";
          if (/-+\s*:$/.test(a)) return "right";
          return "left";
        });

      const rows = [];
      let j = i + 2;
      while (j < lines.length && lines[j].trim().startsWith("|")) {
        const cols = lines[j]
          .trim()
          .split("|")
          .slice(1, -1)
          .map((c) => applyInlineFormatting(c.trim()));
        rows.push(cols);
        j++;
      }

      // Build table HTML
      let html = "<table class='markdown-table'><thead><tr>";
      headers.forEach((h, idx) => {
        html += `<th style="text-align:${aligns[idx]}">${h}</th>`;
      });
      html += "</tr></thead><tbody>";
      rows.forEach((row) => {
        html += "<tr>";
        row.forEach((c, idx) => {
          html += `<td style="text-align:${aligns[idx]}">${c}</td>`;
        });
        html += "</tr>";
      });
      html += "</tbody></table>";
      out.push(html);

      i = j;
      continue;
    }

    // normal line with inline formatting
    out.push(applyInlineFormatting(line));
    i++;
  }

  return out.join("<br>");
}


window.onload = function() {
  const allMessages = document.querySelectorAll('.msg');

  allMessages.forEach((p) => {
    // 🔹 decrypt full message text
    var decryptedTextTemp = decrypt_text(p.innerHTML);

    // 🔹 render markdown (headings, bold, hr, tables, code blocks, line breaks)
    var renderedText = renderLightMarkdown(decryptedTextTemp);

    // 🔹 insert HTML into DOM
    p.innerHTML = renderedText;

  // 🔹 detect Persian (exclude code blocks)
  if (isPersianText(p)) {
      p.style.fontFamily = "IranSans";
      p.style.fontSize = '15px';
      p.style.fontWeight = 'bold';
      p.style.textAlign = 'right';
      p.dir = 'rtl';
      p.style.paddingRight = '10px';
      p.style.lineHeight = 1.65;
    } else {
      p.style.textAlign = 'left';
      p.dir = 'ltr';
    }
  });

  // scroll handling
  var activeThreadId = document.getElementById('active-thread').value;
  var activeThreadElement = document.getElementById(activeThreadId);

  if (activeThreadElement !== null) {
    var isVisible = isElementVisible(activeThreadElement);
    if (activeThreadElement && !isVisible) {
      activeThreadElement.scrollIntoView();
    }
  }

  var containers = document.querySelectorAll(".container");
  if (containers.length > 0) {
    var lastContainer = containers[containers.length - 1];
    lastContainer.scrollIntoView();
  }
  // Prism.js: highlight all code blocks after initial load
  if (window.Prism) {
    Prism.highlightAll();
  }
  // Add copy buttons to code blocks on initial load
  if (typeof installCodeCopy === 'function') installCodeCopy();
};


// Function to check if an element is visible in the viewport
function isElementVisible(element) {
  var rect = element.getBoundingClientRect();
  return (
    rect.top >= 0 &&
    rect.left >= 0 &&
    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
  );
}
function checkNewName(event) {
  var threads = document.getElementsByClassName("thread_name");
  var threadNames = []

  for (var i = 0; i < threads.length; i++) {
    var threadName = threads[i].innerHTML;
    threadNames.push(threadName);
}
  inputName = document.getElementById("rag-name").value
  if (threadNames.includes(inputName)) {
    event.preventDefault();
    spinnerDisappears();
    alert("This thread name already exists! try another name");
  } else if (inputName == "") {
    event.preventDefault();
    spinnerDisappears();
    alert("You must provide a name for this RAG thread!");
  }
};


const baseCollectionSelect = document.querySelector('[name="base-collection-id"]');
const docFormDiv = document.getElementById('doc-form-div');
const docForm = document.getElementById('docForm');

  baseCollectionSelect.addEventListener('change', (event) => {
    const selectedValue = event.target.value;
    if (selectedValue !== 'None') {
      docForm.value = "";
      docFormDiv.style.display = 'none';
    } else {
      docFormDiv.style.display = 'block';
    }
  });


function getContext(button) {
  if (status === "free") {
  var contextDiv = document.getElementById("context-div");
  contextDiv.innerHTML = "";
  var container = button.parentNode;
  var messageId = container.querySelector('.rag-response-id').value;
  var aesRawKey = generateRandomKey(16);
  var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
  localStorage.setItem("aesRawKey_rag", aesRawKey);
  var encrypt = new JSEncrypt();
  encrypt.setPublicKey(publicKey);
  var encryptedAesKey = encrypt.encrypt(aesKey.toString(CryptoJS.enc.Base64));
  if (messageId !== "{{message.id}}") {
    var data = {
    "mode": "context",
    'message_id': messageId,
    "encrypted_aes_key": encryptedAesKey
    }
    socket.send(JSON.stringify(data));
  }
  }
};


function spinnerAppears() {
  spinnerLoader.style.display = 'inline-block' ;
}


function spinnerAppears2() {
  spinnerLoader2.style.display = 'inline-block' ;
}

function spinnerDisappears() {
  spinnerLoader.style.display = 'none' ;
}

function spinnerDisappears2() {
  spinnerLoader2.style.display = 'none' ;
}

// AJAX form submission for chat add documents with progress tracking
function submitChatAddDocsForm(event) {
  event.preventDefault();
  
  // Show spinner and progress
  spinnerLoader2.style.display = 'inline-block';
  var progressIndicator = document.getElementById('progress_indicator_chat');
  if (progressIndicator) {
    progressIndicator.style.display = 'flex';
  }
  
  var form = document.getElementById('chat-add-docs-form');
  if (!form) {
    console.error('Chat add docs form not found');
    return;
  }
  var formData = new FormData(form);
  
  // Start progress polling
  startChatProgressPolling();
  
  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': formData.get('csrfmiddlewaretoken')
    }
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    } else {
      return response.text();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    spinnerDisappears2();
    stopChatProgressPolling();
    alert('An error occurred while adding documents.');
  });
}

var chatProgressInterval = null;

function startChatProgressPolling() {
  console.log('Starting chat add docs progress polling');
  chatProgressInterval = setInterval(() => {
    fetch('/indexing-progress/')
      .then(response => response.json())
      .then(data => {
        console.log('Chat progress data:', data);
        var textElem = document.getElementById('progress_text_chat');
        var filenameElem = document.getElementById('progress_filename_chat');
        var statusElem = document.getElementById('progress_status_chat');
        
        if (textElem && filenameElem && statusElem && data.current && data.total) {
          textElem.textContent = `${data.current} / ${data.total} :`;
          filenameElem.textContent = data.filename || '';
          statusElem.textContent = data.filename ? ' is indexing' : '';
        }
      })
      .catch(error => console.error('Chat progress polling error:', error));
  }, 500);
}

function stopChatProgressPolling() {
  if (chatProgressInterval) {
    clearInterval(chatProgressInterval);
    chatProgressInterval = null;
  }
  var progressIndicator = document.getElementById('progress_indicator_chat');
  if (progressIndicator) {
    progressIndicator.style.display = 'none';
  }
}

// JavaScript to handle the sidebar collapse functionality
  const leftSidebar = document.getElementById('left-sidebar');
  const rightSidebar = document.getElementById('right-sidebar');

  function toggleLeftSidebar() {
    leftSidebar.classList.toggle('collapse');
  }

  function toggleRightSidebar() {
    rightSidebar.classList.toggle('collapse');
  }

  window.addEventListener('resize', function() {
    if (window.innerWidth < 992) {
      leftSidebar.classList.add('collapse');
      rightSidebar.classList.add('collapse');
    } else {
      leftSidebar.classList.remove('collapse');
      rightSidebar.classList.remove('collapse');
    }
  });

function inferTextareaLanguage(content) {
  const str = String(content || '');

  let visibleText = '';
  // If HTML with <pre> blocks is present, strip them via DOM
  if (/<pre[\s>]/i.test(str)) {
    const tmp = document.createElement('div');
    tmp.innerHTML = str;
    tmp.querySelectorAll('pre').forEach(n => n.remove());
    visibleText = (tmp.textContent || '').trim();
  } else {
    // Otherwise, strip Markdown-style code from plain text
    const fencedRe = /```[\s\S]*?```/g;    // triple backtick blocks
    const inlineRe = /`[^`]*`/g;            // inline backticks
    const lines = str
      .replace(fencedRe, '')
      .replace(inlineRe, '')
      .split('\n')
      // drop lines that look like indented code (tabs or >=4 spaces)
      .filter(line => !/^(\t| {4,})/.test(line));
    visibleText = lines.join('\n');
  }

  const totalChars = visibleText.length || 1; // avoid divide by zero
  const englishChars = (visibleText.match(/[A-Za-z]/g) || []).length;
  return (englishChars / totalChars) > 0.3 ? 'English' : 'Persian';
}


function updateMode() {
    const mode = document.querySelector('input[name="chatMode"]:checked').value;
    const ragSection = document.getElementById("ragArgumentsContainer");

    if (mode === "rag") {
        // Show only for RAG mode
        ragSection.style.display = "block";
        // Allow a tiny delay for CSS transition to apply
        requestAnimationFrame(() => {
            ragSection.classList.remove("hidden");
        });
    } else {
        // Hide for standard and database modes
        ragSection.classList.add("hidden");
        // After transition, remove from layout completely
        setTimeout(() => {
            ragSection.style.display = "none";
        }, 300); // match transition duration
    }
}


function updateRerankLabel() {
  const toggle = document.getElementById("rerankSwitch");
  const label = document.getElementById("rerankLabel");
  label.textContent = toggle.checked ? "On" : "Off";
}

function updateCutoffLabel() {
  const slider = document.getElementById("similarityCutoff");
  const label = document.getElementById("cutoffValue");
  label.textContent = parseFloat(slider.value).toFixed(2);
}

function updateTemperatureLabel() {
  const slider = document.getElementById("temperature");
  const label = document.getElementById("temperatureValue");
  label.textContent = parseFloat(slider.value).toFixed(2);
}

// Minimal ChatGPT-like copy button for code blocks (text-only)
function installCodeCopy(root) {
  const scope = root || document;
  scope.querySelectorAll('pre > code').forEach((code) => {
    const pre = code.parentElement;
    if (!pre || pre.querySelector('.code-copy-btn')) return;
    // Ensure positioning context
    if (!pre.style.position) pre.style.position = 'relative';
    const btn = document.createElement('button');
    btn.className = 'code-copy-btn';
    btn.type = 'button';
    btn.title = 'Copy code';
    btn.textContent = 'Copy code';
    // Inline styling to avoid CSS edits
    Object.assign(btn.style, {
      position: 'absolute', top: '8px', right: '8px',
      background: 'rgba(32,34,37,0.85)', border: 'none', borderRadius: '6px',
      padding: '4px 8px', cursor: 'pointer', zIndex: 10, color: '#ffffff',
      fontSize: '12px', lineHeight: '1.2'
    });
    btn.addEventListener('mouseenter', () => { btn.style.background = '#444'; });
    btn.addEventListener('mouseleave', () => { btn.style.background = 'rgba(32,34,37,0.85)'; });
    btn.addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      const text = code.innerText;
      (navigator.clipboard?.writeText(text) || Promise.reject())
        .then(() => {
          btn.textContent = 'Copied';
          setTimeout(() => { btn.textContent = 'Copy code'; }, 1100);
        })
        .catch(() => {
          const ta = document.createElement('textarea');
          ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy');
          document.body.removeChild(ta);
          btn.textContent = 'Copied';
          setTimeout(() => { btn.textContent = 'Copy code'; }, 1100);
        });
    });
    pre.appendChild(btn);
  });
}

// ==================== Modern Input Features ====================

// Auto-resize textarea as user types
const textarea = document.getElementById('msgInput');
const sendBtn = document.getElementById('send_btn');

if (textarea) {
  const inputContainer = textarea.closest('.modern-input-container');
  let previousHeight = textarea.offsetHeight;
  
  // Function to reset textarea to default LTR state
  function resetTextareaDirection() {
    textarea.style.direction = 'ltr';
    textarea.style.textAlign = 'left';
    textarea.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
    textarea.style.height = 'auto';
    previousHeight = textarea.offsetHeight;
  }
  
  // Function to detect if text starts with RTL characters (Arabic/Persian)
  function detectRTL(text) {
    // RTL character ranges: Arabic (0600-06FF), Persian (additional Arabic), Hebrew (0590-05FF)
    const rtlPattern = /[\u0591-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC]/;
    const lines = text.split('\n');
    
    // Check if any line starts with RTL character
    for (let line of lines) {
      const trimmed = line.trim();
      if (trimmed.length > 0 && rtlPattern.test(trimmed[0])) {
        return true;
      }
    }
    return false;
  }
  
  textarea.addEventListener('input', function() {
    // If textarea is empty, reset to LTR
    if (this.value.trim() === '') {
      resetTextareaDirection();
    } else {
      // Detect and set text direction
      const isRTL = detectRTL(this.value);
      this.style.direction = isRTL ? 'rtl' : 'ltr';
      this.style.textAlign = isRTL ? 'right' : 'left';
      this.style.fontFamily = isRTL ? 'IranSans, Tahoma, Arial' : '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
    }
    // Reset height to get accurate scrollHeight
    this.style.height = 'auto';
    const newHeight = Math.min(this.scrollHeight, 200);
    this.style.height = newHeight + 'px';
    
    // Calculate height difference
    const heightDiff = newHeight - previousHeight;
    
    // Adjust container position to expand upward (shift up by the height difference)
    if (inputContainer && heightDiff !== 0) {
      const currentBottom = parseInt(window.getComputedStyle(inputContainer).bottom) || 0;
      // We don't change bottom - the container naturally grows upward from its fixed bottom position
      // The absolute positioning at bottom: 0 ensures it stays anchored at the bottom
    }
    
    previousHeight = newHeight;
    
    // Enable/disable send button based on content
    if (sendBtn) {
      sendBtn.disabled = this.value.trim() === '';
    }
  });

  // Handle Enter key (send) and Shift+Enter (new line)
  textarea.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (this.value.trim() !== '') {
        document.getElementById('msg-form').dispatchEvent(new Event('submit'));
      }
    }
  });

  // Initial state
  if (sendBtn) {
    sendBtn.disabled = textarea.value.trim() === '';
  }
  
  // Set initial height
  previousHeight = textarea.offsetHeight;
}

// File attachment handling
const attachBtn = document.getElementById('attach-btn');
const fileInput = document.getElementById('file-input');
const filePreviewContainer = document.getElementById('file-preview-container');
const fileItemTemplate = document.getElementById('file-item-template');
let selectedFiles = [];

if (attachBtn && fileInput) {
  attachBtn.addEventListener('click', function() {
    fileInput.click();
  });

  fileInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    
    if (files.length > 0) {
      selectedFiles = files;
      updateFilePreview();
    }
  });
}

function updateFilePreview() {
  if (!filePreviewContainer || !fileItemTemplate) return;
  
  const attachedFilesContainer = filePreviewContainer.querySelector('.attached-files');
  if (!attachedFilesContainer) return;
  
  // Clear existing file items (except template)
  attachedFilesContainer.querySelectorAll('.file-item:not(#file-item-template)').forEach(item => {
    item.remove();
  });
  
  if (selectedFiles.length > 0) {
    selectedFiles.forEach((file, index) => {
      const fileItem = fileItemTemplate.cloneNode(true);
      fileItem.id = '';
      fileItem.style.display = 'inline-flex';
      fileItem.querySelector('.file-name').textContent = file.name;
      fileItem.querySelector('.remove-file-btn').onclick = () => removeFile(index);
      attachedFilesContainer.appendChild(fileItem);
    });
    
    filePreviewContainer.style.display = 'block';
  } else {
    filePreviewContainer.style.display = 'none';
  }
}

function removeFile(index) {
  if (index !== undefined) {
    selectedFiles.splice(index, 1);
  } else {
    selectedFiles = [];
  }
  
  // Update the file input
  if (fileInput) {
    fileInput.value = '';
  }
  
  updateFilePreview();
}

// ==================== End Modern Input Features ====================

</script>
</body>
</html>